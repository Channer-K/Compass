<form id="form-{{req_step.pk}}" action="{% url 'go-next' %}" method="POST" role="form">
  {% csrf_token %}
  <input type="hidden" name="sid" value="{{req_step.pk}}">
  {% if perms.compass.distribute_task %}
  <p><b>任务分配</b></p>
  <table class="table table-hover" style="table-layout: fixed;">
    <thead>
      <tr>
        <td style="display: none;"></td>
        <td>发布环境</td>
        <td>发布者</td>
        <td>发布时间</td>
      </tr>
    </thead>
    <tbody>
    {% for sub in pub_tasks %}
      <tr>
        <td style="display: none;"><input type="hidden" name="subtask" value="{{sub.pk}}"></td>
        <td>{{sub.environment.name}}</td>
        <td>
          <select data-toggle='herolist' name="pub_user" class="select-block">
            {% for sa in pub_users %}
              <option value="{{sa.pk}}" {% if sub.assignee == sa %}selected="selected"{% endif %}>{{sa}}</option>
            {% empty %}
              <option value="0">无可分配人员... ...</option>
            {% endfor %}
              <option value="0">暂不分配</option>
          </select>
        </td>
        <td>
          <div class="form-group">
            <input type="text" class="form-control" name="pub_date" id="id_pub_date_{{sub.pk}}" readonly>
            <span class="input-icon fui-calendar-solid"></span>
          </div>
        </td>
      </tr>
    {% endfor %}
    {% endif %}
    </tbody>
  </table>
  {% if perms.compass.distribute_task %}
    <button type="submit" class="btn btn-primary btn-sm" name="opt" value="dist">分配任务</button>
  {% elif req_step.assignee == user %}
    <p>等待运维组长分配发布时间。</p>
  {% endif %}
</form>

<script>
  {% for sub in task.subtask_set.all %}
    $("#id_pub_date_{{sub.pk}}").datetimepicker({minDate: 0, timeFormat: 'HH'});
  {% endfor %}
</script>
